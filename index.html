<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRESTIJ6 - Portal Prestasi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .card { border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); transition: all 0.3s ease; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); }
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: url('https://images.unsplash.com/photo-1519681393784-d120267933ba?auto=format&fit=crop&q=80&w=2070') center center/cover; }
        .login-card { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px); border-radius: 1.5rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.3); padding: 2.5rem; width: 100%; max-width: 28rem; text-align: center; border: 1px solid rgba(255,255,255,0.2); }
        .notification { position: fixed; bottom: 1rem; right: 1rem; z-index: 50; animation: slideIn 0.5s forwards, fadeOut 0.5s 4.5s forwards; }
        @keyframes slideIn { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .hidden { display: none; }
        
        /* === GAYA BAHARU UNTUK LENCANA & TUGASAN === */
        .badge {
            transition: all 0.3s ease;
            cursor: default;
        }
        .badge-glow-yellow:hover { box-shadow: 0 0 15px rgba(234, 179, 8, 0.7); transform: scale(1.05); }
        .badge-glow-blue:hover { box-shadow: 0 0 15px rgba(59, 130, 246, 0.7); transform: scale(1.05); }
        .badge-glow-green:hover { box-shadow: 0 0 15px rgba(34, 197, 94, 0.7); transform: scale(1.05); }
        .badge-glow-purple:hover { box-shadow: 0 0 15px rgba(168, 85, 247, 0.7); transform: scale(1.05); }
        
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .accordion-content.open {
            max-height: 500px; /* Nilai yang cukup besar untuk memuatkan kandungan */
        }
        .task-item input:checked + label {
            text-decoration: line-through;
            color: #9ca3af; /* gray-400 */
        }
        /* === TAMAT GAYA BAHARU === */

    </style>
</head>
<body class="bg-gray-50">

    <!-- HALAMAN LOG MASUK (Lalai) -->
    <div id="loginPage">
        <!-- KANDUNGAN YANG HILANG TELAH DIKEMBALIKAN DI SINI -->
        <div class="login-container">
            <div class="login-card">
                <div class="mb-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M12 14l9-5-9-5-9 5 9 5z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14zm-4 6v-7.5l4-2.222 4 2.222V20" /></svg></div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Portal Prestasi PRESTIJ6</h1>
                <p class="text-gray-600 mb-8">Sila log masuk untuk meneruskan.</p>
                <div id="loginAlert" class="hidden text-left bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4"></div>
                <form id="loginForm">
                    <div class="mb-4 text-left"><label for="loginId" class="block text-gray-700 text-sm font-bold mb-2">ID Pengguna:</label><input type="text" id="loginId" class="shadow-inner appearance-none border rounded-lg w-full py-3 px-4 text-gray-700" placeholder="ID Guru atau Pelajar" required></div>
                    <div class="mb-6 text-left"><label for="loginPassword" class="block text-gray-700 text-sm font-bold mb-2">Kata Laluan:</label><input type="password" id="loginPassword" class="shadow-inner appearance-none border rounded-lg w-full py-3 px-4 text-gray-700" required></div>
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg">Log Masuk</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- PORTAL UTAMA (Disembunyikan) -->
    <div id="mainPortal" class="hidden min-h-screen bg-gradient-to-br from-indigo-50 to-blue-50">
        <nav class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold">PRESTIJ6</h1>
                <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Log Keluar</button>
            </div>
        </nav>
        <div class="container mx-auto px-4 py-6">
            <div class="card bg-white p-6 mb-8"><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-center"><div class="lg:col-span-1"><button id="connectFileBtn" class="w-full text-center p-3 border-2 border-dashed border-gray-300 rounded-lg">Sambung / Ganti Fail Data</button><input type="file" id="csvFileInput" class="hidden" accept=".csv"></div><div class="lg:col-span-2"><label for="studentSelector" class="block text-sm font-medium text-gray-700 mb-1">Pilih Pelajar:</label><select id="studentSelector" class="w-full p-3 border-gray-300 rounded-lg" disabled><option>Sila muat naik fail data</option></select></div></div></div>
            
            <div id="mainDashboardContent" class="hidden">
                <div class="card bg-white p-6 mb-8"><div class="flex flex-col md:flex-row justify-between items-center"><div><h2 class="text-2xl font-bold text-gray-800" id="student-full-name">--</h2><p class="text-gray-600" id="student-class">--</p></div><div class="mt-4 md:mt-0 text-right"><p class="text-sm">Purata Markah</p><p class="text-3xl font-bold text-indigo-600" id="student-average">--%</p></div></div></div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <div class="card bg-white p-6 lg:col-span-2"><h3 class="text-lg font-semibold mb-4">Perbandingan Prestasi</h3><div class="h-80"><canvas id="performanceChart"></canvas></div></div>
                    <div class="card bg-white p-6"><h3 class="text-lg font-semibold mb-4">Pecahan Markah</h3><div id="subject-bars-container" class="space-y-4"></div></div>
                </div>

                <!-- === BAHAGIAN BARU UNTUK LENCANA DAN TUGASAN === -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <!-- KAD PENCAPAIAN & LENCANA -->
                    <div class="card bg-white p-6">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">Pencapaian & Lencana</h3>
                        <div id="achievements-container" class="flex flex-wrap gap-4 justify-center items-start">
                            <!-- Lencana akan dijana oleh JavaScript di sini -->
                        </div>
                    </div>
                    
                    <!-- KAD TUGASAN & AKTIVITI -->
                    <div class="card bg-white p-6">
                         <h3 class="text-lg font-semibold mb-4 text-gray-800">Tugasan & Aktiviti</h3>
                         <div id="tasks-container" class="space-y-2">
                             <!-- Tugasan akan dijana oleh JavaScript di sini -->
                         </div>
                    </div>
                </div>
                <!-- === TAMAT BAHAGIAN BARU === -->
            </div>
        </div>
    </div>
    <div id="notification" class="hidden"></div>

<script>
// ======================================================
// PEMBOLEHUBAH & KONFIGURASI
// ======================================================
let allStudentData = [];
let subjectNames = [];
let charts = {};

// ======================================================
// FUNGSI UTAMA APP
// ======================================================
document.addEventListener('DOMContentLoaded', () => {
    const isLoggedIn = sessionStorage.getItem('isLoggedIn') === 'true';
    if (isLoggedIn) {
        renderPortal();
    } else {
        showLoginPage();
    }
});

function showNotification(message, type = 'success') {
    const el = document.getElementById('notification');
    if(el) {
        el.textContent = message;
        el.className = `notification ${type === 'error' ? 'bg-red-500' : 'bg-green-500'} text-white px-4 py-3 rounded-lg shadow-lg`;
        setTimeout(() => { el.className = 'hidden'; }, 4000);
    }
}

// ======================================================
// LOGIK LOG MASUK & PENGURUSAN PAPARAN
// ======================================================
function handleLogin(event) {
    event.preventDefault();
    const id = document.getElementById('loginId').value.toLowerCase();
    const password = document.getElementById('loginPassword').value;
    
    const isGuru = (id === 'guru' && password === 'admin123');
    const isPelajar = (id === 'smklbm' && password === '1234');

    if (isGuru || isPelajar) {
        sessionStorage.setItem('isLoggedIn', 'true');
        showNotification('Log masuk berjaya!', 'success');
        renderPortal();
    } else {
        const alertBox = document.getElementById('loginAlert');
        alertBox.textContent = 'ID Pengguna atau Kata Laluan tidak sah.';
        alertBox.classList.remove('hidden');
    }
}

function logout() {
    sessionStorage.removeItem('isLoggedIn');
    showNotification('Anda telah berjaya log keluar.', 'success');
    showLoginPage();
}

function showLoginPage() {
    document.getElementById('loginPage').classList.remove('hidden');
    document.getElementById('mainPortal').classList.add('hidden');
    // Pastikan event listener dipasang semula jika pengguna log keluar
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
        loginForm.addEventListener('submit', handleLogin);
    }
}

function renderPortal() {
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('mainPortal').classList.remove('hidden');

    // Pasang semua event listener untuk portal
    document.getElementById('logoutBtn').addEventListener('click', logout);
    document.getElementById('connectFileBtn').addEventListener('click', () => document.getElementById('csvFileInput').click());
    document.getElementById('csvFileInput').addEventListener('change', (event) => {
        if (event.target.files.length > 0) processCSV(event.target.files[0]);
    });
    document.getElementById('studentSelector').addEventListener('change', (event) => {
        displayStudentData(allStudentData[event.target.value]);
    });
}

// ======================================================
// PEMPROSESAN CSV & FUNGSI PAPARAN GURU
// ======================================================
function processCSV(file) {
    showNotification(`Memproses fail...`, 'success');
    Papa.parse(file, {
        skipEmptyLines: true,
        complete: (results) => {
            try {
                const data = results.data;
                const headerRowIndex = data.findIndex(row => (row[2] || '').trim().toUpperCase() === 'NAMA');
                if (headerRowIndex === -1) throw new Error("Lajur 'NAMA' tidak ditemui. Sila semak fail CSV anda.");
                
                const rawHeaders = data[headerRowIndex];
                const headerMap = {};
                subjectNames = [];
                rawHeaders.forEach((header, index) => {
                    const cleanHeader = (header || '').trim();
                    if (cleanHeader && !cleanHeader.toUpperCase().includes('GRED')) {
                        headerMap[cleanHeader.toUpperCase()] = index;
                        if (!['NAMA', 'KELAS', 'BIL'].includes(cleanHeader.toUpperCase())) {
                            subjectNames.push(cleanHeader);
                        }
                    }
                });

                const processedData = [];
                for (let i = headerRowIndex + 1; i < data.length; i++) {
                    const row = data[i];
                    const studentName = row[headerMap['NAMA']];
                    if (!studentName || studentName.trim().toUpperCase() === 'KETERANGAN') continue;
                    
                    const student = { name: studentName.trim(), class: (row[headerMap['KELAS']] || 'TIADA').trim(), subjects: {} };
                    subjectNames.forEach(subj => {
                        student.subjects[subj.toUpperCase()] = parseInt(row[headerMap[subj.toUpperCase()]], 10) || 0;
                    });
                    
                    const scores = Object.values(student.subjects).filter(s => s > 0);
                    student.average = scores.length > 0 ? scores.reduce((a, b) => a + b) / scores.length : 0;
                    processedData.push(student);
                }

                if (processedData.length === 0) throw new Error("Tiada data pelajar yang sah ditemui.");
                
                allStudentData = processedData;
                showNotification(`${allStudentData.length} rekod pelajar berjaya disimpan!`, 'success');
                populateStudentSelector();
                displayStudentData(allStudentData[0]);

            } catch (error) {
                showNotification(`Ralat: ${error.message}`, 'error');
            }
        }
    });
}

function populateStudentSelector() {
    const selector = document.getElementById('studentSelector');
    selector.innerHTML = '';
    selector.disabled = false;
    allStudentData.sort((a,b) => a.name.localeCompare(b.name)).forEach((student, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = `${student.name} (${student.class})`;
        selector.appendChild(option);
    });
}

function displayStudentData(student) {
    if (!student) return;
    document.getElementById('mainDashboardContent').classList.remove('hidden');
    document.getElementById('student-full-name').textContent = student.name;
    document.getElementById('student-class').textContent = `Tingkatan 6 ${student.class}`;
    document.getElementById('student-average').textContent = `${(student.average || 0).toFixed(1)}%`;
    
    const validSubjects = Object.fromEntries(Object.entries(student.subjects).filter(([_, score]) => score > 0));
    
    renderPerformanceChart(student, validSubjects);
    renderSubjectBars(validSubjects);
    renderAchievements(student);
    renderTasks();
}

function renderPerformanceChart(student, studentSubjects) {
    const ctx = document.getElementById('performanceChart').getContext('2d');
    const labels = Object.keys(studentSubjects);
    const studentScores = labels.map(key => studentSubjects[key]);
    
    const classAverages = {};
    labels.forEach(subject => {
        const scores = allStudentData.map(s => s.subjects[subject] || 0).filter(score => score > 0);
        classAverages[subject] = scores.length > 0 ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;
    });
    const averageScores = labels.map(key => classAverages[key]);

    if (charts.performance) charts.performance.destroy();
    charts.performance = new Chart(ctx, {
        type: 'radar', data: { labels, datasets: [
            { label: 'Skor Anda', data: studentScores, fill: true, backgroundColor: 'rgba(79, 70, 229, 0.2)', borderColor: 'rgb(79, 70, 229)' }, 
            { label: 'Purata Kelas', data: averageScores, fill: true, backgroundColor: 'rgba(156, 163, 175, 0.2)', borderColor: 'rgb(156, 163, 175)' }
        ]},
        options: { responsive: true, maintainAspectRatio: false, scales: { r: { suggestedMin: 0, suggestedMax: 100 } } }
    });
}

function renderSubjectBars(subjects) {
    const container = document.getElementById('subject-bars-container');
    container.innerHTML = '';
    for (const [subject, score] of Object.entries(subjects)) {
        let colorClass = score >= 80 ? 'bg-green-500' : score >= 60 ? 'bg-blue-500' : score >= 40 ? 'bg-yellow-500' : 'bg-red-500';
        container.innerHTML += `<div><div class="flex justify-between mb-1"><span class="text-sm font-medium text-gray-700">${subject}</span><span class="text-sm font-medium text-gray-700">${score}%</span></div><div class="w-full bg-gray-200 rounded-full h-2.5"><div class="${colorClass} h-2.5 rounded-full" style="width: ${score}%"></div></div></div>`;
    }
}


// ======================================================
// FUNGSI BAHARU: PAPARAN LENCANA & TUGASAN
// ======================================================

/**
 * Menjana dan memaparkan lencana berdasarkan prestasi pelajar.
 * @param {object} student Objek data pelajar.
 */
function renderAchievements(student) {
    const container = document.getElementById('achievements-container');
    container.innerHTML = ''; // Kosongkan lencana lama
    let badgesHTML = '';

    const badgeData = [
        { name: 'Jaguh Pengajian Am', subject: 'PENGAJIAN AM', threshold: 85, icon: 'ðŸ†', color: 'yellow' },
        { name: 'Sejarawan Muda', subject: 'SEJARAH', threshold: 85, icon: 'ðŸ›ï¸', color: 'blue' },
        { name: 'Sasterawan Harapan', subject: 'KESUSASTERAAN MELAYU KOMUNIKATIF', threshold: 85, icon: 'ðŸ“š', color: 'purple' },
        { name: 'Ahli Perniagaan', subject: 'PENGAJIAN PERNIAGAAN', threshold: 85, icon: 'ðŸ’¼', color: 'green' },
        { name: 'Pencapaian Cemerlang', subject: 'average', threshold: 90, icon: 'â­', color: 'yellow' },
    ];

    badgeData.forEach(badge => {
        const score = badge.subject === 'average' ? student.average : (student.subjects[badge.subject.toUpperCase()] || 0);
        if (score >= badge.threshold) {
            badgesHTML += `
                <div class="badge badge-glow-${badge.color} text-center p-3 bg-gray-50 rounded-lg w-32 border border-gray-200">
                    <div class="text-4xl">${badge.icon}</div>
                    <p class="text-sm font-semibold text-gray-700 mt-2">${badge.name}</p>
                </div>
            `;
        }
    });

    if (badgesHTML === '') {
        container.innerHTML = `<p class="text-gray-500 text-center w-full">Tiada lencana diperoleh lagi. Teruskan usaha anda!</p>`;
    } else {
        container.innerHTML = badgesHTML;
    }
}

/**
 * Menjana senarai tugasan (dummy data) dan memaparkannya dalam format akordion.
 */
function renderTasks() {
    const container = document.getElementById('tasks-container');
    container.innerHTML = ''; // Kosongkan tugasan lama

    const tasksData = {
        "Pengajian Am": [
            { name: "Hantar draf kerja kursus Bab 1", completed: true },
            { name: "Bacaan tambahan topik Kenegaraan", completed: true },
            { name: "Latihan graf & carta", completed: false },
        ],
        "Sejarah": [
            { name: "Pembentangan Tamadun Islam", completed: true },
            { name: "Analisis sumber primer Perang Dunia Pertama", completed: false },
        ],
        "Bahasa Melayu": [
            { name: "Analisis novel Interlok", completed: true },
            { name: "Latihan penulisan esei tidak berformat", completed: false },
        ],
        "Kesusasteraan Melayu Komunikatif": [
            { name: "Pementasan puisi moden", completed: true },
            { name: "Analisis watak & perwatakan cerpen", completed: false },
        ],
        "Pengajian Perniagaan": [
            { name: "Kajian kes syarikat tempatan", completed: true },
            { name: "Latihan penyediaan rancangan perniagaan", completed: false },
        ],
    };

    let tasksHTML = '';
    Object.keys(tasksData).forEach((subject, index) => {
        tasksHTML += `
            <div>
                <button id="accordion-btn-${index}" class="accordion-btn w-full flex justify-between items-center p-3 bg-gray-100 hover:bg-gray-200 rounded-lg text-left font-semibold text-gray-700">
                    <span>${subject}</span>
                    <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="accordion-content-${index}" class="accordion-content mt-2 pl-4 border-l-2 border-indigo-200">
                    <ul class="space-y-2 py-2">
        `;
        tasksData[subject].forEach((task, taskIndex) => {
            const isChecked = task.completed ? 'checked' : '';
            tasksHTML += `
                <li class="task-item flex items-center">
                    <input type="checkbox" id="task-${index}-${taskIndex}" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" ${isChecked} disabled>
                    <label for="task-${index}-${taskIndex}" class="ml-3 block text-sm text-gray-600">${task.name}</label>
                </li>
            `;
        });
        tasksHTML += `</ul></div></div>`;
    });

    container.innerHTML = tasksHTML;

    // Tambah event listener untuk fungsi akordion
    Object.keys(tasksData).forEach((_, index) => {
        const btn = document.getElementById(`accordion-btn-${index}`);
        const content = document.getElementById(`accordion-content-${index}`);
        const icon = btn.querySelector('svg');
        btn.addEventListener('click', () => {
            const isOpen = content.classList.contains('open');
            // Tutup semua akordion lain yang sedang terbuka
            document.querySelectorAll('.accordion-content.open').forEach(openContent => {
                if (openContent !== content) {
                    openContent.classList.remove('open');
                    openContent.previousElementSibling.querySelector('svg').classList.remove('rotate-180');
                }
            });
            // Buka/tutup yang semasa
            content.classList.toggle('open');
            icon.classList.toggle('rotate-180');
        });
    });
}
</script>
</body>
</html>